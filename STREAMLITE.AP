"""
Medical Appointment No-Show Prediction & Demand Forecasting
Interactive Streamlit Dashboard for clinic operations
"""

import streamlit as st
import pandas as pd
import numpy as np
import joblib
import plotly.graph_objects as go
import plotly.express as px
from datetime import datetime, timedelta
import warnings

warnings.filterwarnings('ignore')

# Page Configuration
st.set_page_config(
    page_title="Medical Appointment Analytics",
    page_icon="üè•",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS
st.markdown("""
    <style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 20px;
    }
    .metric-card {
        background-color: #f0f2f6;
        padding: 20px;
        border-radius: 10px;
        margin: 10px 0;
    }
    .risk-high {
        color: #d62728;
        font-weight: bold;
    }
    .risk-medium {
        color: #ff7f0e;
        font-weight: bold;
    }
    .risk-low {
        color: #2ca02c;
        font-weight: bold;
    }
    </style>
""", unsafe_allow_html=True)

# Load Models (Cached)
@st.cache_resource
def load_models():
    try:
        noshow_model = joblib.load("../models/noshow_classifier.pkl")
        demand_model = joblib.load("../models/demand_forecast_model.pkl")
        preprocessor = joblib.load("../models/preprocessor.pkl")
        return noshow_model, demand_model, preprocessor
    except FileNotFoundError:
        st.error("‚ö†Ô∏è Models not found. Please ensure models are trained and saved.")
        return None, None, None

# Load sample data for reference
@st.cache_data
def load_sample_data():
    try:
        df = pd.read_csv("../data/medical_appointments.csv")
        return df
    except FileNotFoundError:
        st.warning("Sample data not available")
        return None

# Risk Level Classification
def classify_risk(probability):
    """Classify risk based on probability"""
    if probability >= 0.7:
        return "üî¥ HIGH RISK", "risk-high"
    elif probability >= 0.4:
        return "üü† MEDIUM RISK", "risk-medium"
    else:
        return "üü¢ LOW RISK", "risk-low"

# Risk Gauge Chart
def create_risk_gauge(probability):
    """Create a gauge chart for risk visualization"""
    fig = go.Figure(data=[go.Indicator(
        mode="gauge+number+delta",
        value=probability * 100,
        domain={'x': [0, 1], 'y': [0, 1]},
        title={'text': "No-Show Risk (%)"},
        delta={'reference': 50},
        gauge={'axis': {'range': [None, 100]},
               'bar': {'color': "darkblue"},
               'steps': [
                   {'range': [0, 33], 'color': "lightgreen"},
                   {'range': [33, 67], 'color': "lightyellow"},
                   {'range': [67, 100], 'color': "lightcoral"}],
               'threshold': {'line': {'color': "red", 'width': 4},
                            'thickness': 0.75,
                            'value': 70}},
        number={'suffix': "%"}
    )])
    fig.update_layout(height=400, margin=dict(l=20, r=20, t=60, b=20))
    return fig

# ==================== SIDEBAR ====================
st.sidebar.markdown("# üè• Medical Appointment Analytics")
st.sidebar.markdown("---")

option = st.sidebar.radio(
    "Select Module",
    ["üéØ No-Show Predictor", "üìä Demand Forecaster", "üìà Model Performance"]
)

# Load Models
noshow_model, demand_model, preprocessor = load_models()

# ==================== NO-SHOW PREDICTOR ====================
if option == "üéØ No-Show Predictor":
    st.markdown("<h1 class='main-header'>Patient No-Show Risk Prediction</h1>", unsafe_allow_html=True)
    
    st.info("""
    üìã **How it works:** Enter patient information and appointment details below. 
    The model will predict the probability of the patient missing their appointment 
    and provide recommendations.
    """)
    
    # Create input form
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.subheader("üë§ Patient Demographics")
        gender = st.selectbox("Gender", ["Male", "Female"])
        age = st.number_input("Age", min_value=0, max_value=120, value=35)
        
        # Age categories
        under_12 = 1 if age < 12 else 0
        over_60 = 1 if age > 60 else 0
    
    with col2:
        st.subheader("üè• Appointment Details")
        specialty = st.selectbox(
            "Specialty",
            ["Physiotherapy", "Psychology", "Speech Therapy", "Occupational Therapy", "General"]
        )
        appointment_date = st.date_input("Appointment Date")
        appointment_shift = st.selectbox("Shift", ["Morning", "Afternoon", "Evening"])
    
    with col3:
        st.subheader("üìç Location & Advance Notice")
        place = st.selectbox(
            "City",
            ["City_A", "City_B", "City_C", "City_D", "City_E", "City_F", "City_G"]
        )
        days_advance = st.number_input("Days in Advance", min_value=0, max_value=365, value=7)
    
    st.markdown("---")
    
    col4, col5 = st.columns(2)
    
    with col4:
        st.subheader("üè• Health Conditions")
        hypertension = st.checkbox("Hypertension", value=False)
        diabetes = st.checkbox("Diabetes", value=False)
        alcoholism = st.checkbox("Alcoholism", value=False)
        handicap = st.checkbox("Handicap", value=False)
    
    with col5:
        st.subheader("üì± Engagement & Support")
        sms_received = st.checkbox("SMS Reminder Received", value=True)
        needs_companion = st.checkbox("Needs Companion", value=False)
        scholarship = st.checkbox("Scholarship Recipient", value=False)
    
    st.markdown("---")
    
    col6, col7 = st.columns(2)
    
    with col6:
        st.subheader("üå§Ô∏è Weather Conditions")
        avg_temp = st.slider("Average Temperature (¬∞C)", -10, 50, 25)
        rainfall = st.slider("Rainfall (mm)", 0, 300, 0)
    
    with col7:
        st.subheader("‚ö° Weather Impact")
        rain_intensity = st.slider("Rain Intensity", 0.0, 1.0, 0.0)
        rainy_day_before = st.checkbox("Rainy Day Before", value=False)
        storm_day_before = st.checkbox("Storm Day Before", value=False)
    
    st.markdown("---")
    
    # Prediction Button
    col_btn1, col_btn2, col_btn3 = st.columns([1, 1, 2])
    
    with col_btn1:
        predict_button = st.button("üîÆ Predict No-Show Risk", use_container_width=True)
    
    with col_btn2:
        reset_button = st.button("üîÑ Reset Form", use_container_width=True)
    
    if reset_button:
        st.rerun()
    
    # Make Prediction
    if predict_button:
        if noshow_model is not None:
            with st.spinner("üîÑ Analyzing patient data..."):
                # Prepare input data
                input_data = {
                    'gender': gender,
                    'age': age,
                    'under_12': under_12,
                    'over_60': over_60,
                    'place': place,
                    'specialty': specialty,
                    'appointment_date': appointment_date,
                    'appointment_shift': appointment_shift,
                    'days_advance': days_advance,
                    'hypertension': int(hypertension),
                    'diabetes': int(diabetes),
                    'alcoholism': int(alcoholism),
                    'handicap': int(handicap),
                    'sms_received': int(sms_received),
                    'needs_companion': int(needs_companion),
                    'scholarship': int(scholarship),
                    'avg_temp': avg_temp,
                    'rainfall': rainfall,
                    'rain_intensity': rain_intensity,
                    'rainy_day_before': int(rainy_day_before),
                    'storm_day_before': int(storm_day_before)
                }
                
                # Create DataFrame
                input_df = pd.DataFrame([input_data])
                
                try:
                    # Get prediction
                    prediction_proba = noshow_model.predict_proba(input_df)[0]
                    no_show_probability = prediction_proba[1]
                    show_probability = prediction_proba[0]
                    
                    # Display Results
                    st.markdown("---")
                    st.subheader("üìä Prediction Results")
                    
                    # Create two columns for results
                    result_col1, result_col2 = st.columns([1.5, 1])
                    
                    with result_col1:
                        # Gauge chart
                        fig_gauge = create_risk_gauge(no_show_probability)
                        st.plotly_chart(fig_gauge, use_container_width=True)
                    
                    with result_col2:
                        risk_text, risk_class = classify_risk(no_show_probability)
                        st.markdown(f"<p class='{risk_class}'>{risk_text}</p>", unsafe_allow_html=True)
                        
                        st.metric("No-Show Probability", f"{no_show_probability:.1%}")
                        st.metric("Show Probability", f"{show_probability:.1%}")
                    
                    st.markdown("---")
                    
                    # Recommendations
                    st.subheader("üí° Recommendations")
                    
                    if no_show_probability >= 0.7:
                        st.error("""
                        **HIGH RISK - Immediate Action Recommended:**
                        - Send SMS reminder to patient
                        - Consider phone call confirmation 24 hours before
                        - Have backup appointment slot available
                        - Offer alternative scheduling options
                        """)
                    elif no_show_probability >= 0.4:
                        st.warning("""
                        **MEDIUM RISK - Proactive Engagement:**
                        - Send SMS reminder
                        - Monitor appointment status closely
                        - Prepare contingency staffing plans
                        - Consider offering transport assistance if applicable
                        """)
                    else:
                        st.success("""
                        **LOW RISK - Standard Operations:**
                        - Routine SMS reminder recommended
                        - Standard staffing allocation
                        - Monitor for any changes in patient status
                        """)
                    
                    # Factors affecting prediction
                    st.markdown("---")
                    st.subheader("üîç Key Factors Analysis")
                    
                    factor_col1, factor_col2, factor_col3 = st.columns(3)
                    
                    with factor_col1:
                        st.info(f"""
                        **Days in Advance:** {days_advance}
                        - More advance notice ‚Üí Lower risk
                        """)
                    
                    with factor_col2:
                        st.info(f"""
                        **SMS Received:** {'Yes' if sms_received else 'No'}
                        - SMS reminders increase show rate
                        """)
                    
                    with factor_col3:
                        st.info(f"""
                        **Age Group:** {age} years
                        - Age patterns influence attendance
                        """)
                
                except Exception as e:
                    st.error(f"‚ùå Prediction error: {str(e)}")
        else:
            st.error("‚ùå Models not loaded. Please check the models folder.")

# ==================== DEMAND FORECASTER ====================
elif option == "üìä Demand Forecaster":
    st.markdown("<h1 class='main-header'>Appointment Demand Forecasting</h1>", unsafe_allow_html=True)
    
    st.info("""
    üìà **How it works:** Select your forecasting parameters below to predict 
    appointment volumes. This helps with staff scheduling and resource planning.
    """)
    
    # Forecasting parameters
    col1, col2, col3 = st.columns(3)
    
    with col1:
        forecast_days = st.selectbox("Forecast Period", [7, 14, 30])
    
    with col2:
        forecast_specialty = st.selectbox(
            "Filter by Specialty (Optional)",
            ["All Specialties", "Physiotherapy", "Psychology", "Speech Therapy", "Occupational Therapy"]
        )
    
    with col3:
        forecast_from_date = st.date_input("Start Date", datetime.now().date())
    
    st.markdown("---")
    
    forecast_button = st.button("üìä Generate Forecast", use_container_width=True)
    
    if forecast_button:
        if demand_model is not None:
            with st.spinner("üîÑ Generating demand forecast..."):
                try:
                    # Create forecast data
                    forecast_dates = [forecast_from_date + timedelta(days=i) for i in range(forecast_days)]
                    
                    # Simulate forecast (in real implementation, use actual model predictions)
                    # This is a placeholder - replace with actual model predictions
                    base_demand = np.random.uniform(80, 150, forecast_days)
                    forecast_values = np.cumsum(np.random.normal(0, 5, forecast_days)) + base_demand
                    forecast_values = np.maximum(forecast_values, 20)  # Ensure positive values
                    
                    # Create forecast DataFrame
                    forecast_df = pd.DataFrame({
                        'Date': forecast_dates,
                        'Predicted_Demand': forecast_values,
                        'Lower_Bound': forecast_values * 0.85,
                        'Upper_Bound': forecast_values * 1.15
                    })
                    
                    # Display metrics
                    metric_col1, metric_col2, metric_col3, metric_col4 = st.columns(4)
                    
                    with metric_col1:
                        st.metric("Forecast Period", f"{forecast_days} days")
                    
                    with metric_col2:
                        st.metric("Average Daily Demand", f"{forecast_df['Predicted_Demand'].mean():.0f}")
                    
                    with metric_col3:
                        st.metric("Peak Demand", f"{forecast_df['Predicted_Demand'].max():.0f}")
                    
                    with metric_col4:
                        st.metric("Low Demand", f"{forecast_df['Predicted_Demand'].min():.0f}")
                    
                    st.markdown("---")
                    
                    # Forecast Chart
                    st.subheader("üìà Demand Forecast Chart")
                    
                    fig = go.Figure()
                    
                    # Add confidence interval
                    fig.add_trace(go.Scatter(
                        x=forecast_df['Date'],
                        y=forecast_df['Upper_Bound'],
                        fill=None,
                        mode='lines',
                        line_color='rgba(0,0,0,0)',
                        showlegend=False,
                        name='Upper Bound'
                    ))
                    
                    fig.add_trace(go.Scatter(
                        x=forecast_df['Date'],
                        y=forecast_df['Lower_Bound'],
                        fill='tonexty',
                        mode='lines',
                        line_color='rgba(0,0,0,0)',
                        name='Confidence Interval (¬±15%)',
                        fillcolor='rgba(0,100,200,0.2)'
                    ))
                    
                    # Add forecast line
                    fig.add_trace(go.Scatter(
                        x=forecast_df['Date'],
                        y=forecast_df['Predicted_Demand'],
                        mode='lines+markers',
                        name='Predicted Demand',
                        line=dict(color='#1f77b4', width=3),
                        marker=dict(size=8)
                    ))
                    
                    fig.update_layout(
                        title="Daily Appointment Demand Forecast",
                        xaxis_title="Date",
                        yaxis_title="Number of Appointments",
                        hovermode='x unified',
                        height=500,
                        template='plotly_light'
                    )
                    
                    st.plotly_chart(fig, use_container_width=True)
                    
                    st.markdown("---")
                    
                    # Forecast Table
                    st.subheader("üìã Detailed Forecast Table")
                    
                    display_df = forecast_df.copy()
                    display_df['Date'] = display_df['Date'].dt.strftime('%Y-%m-%d')
                    display_df['Predicted_Demand'] = display_df['Predicted_Demand'].round(0).astype(int)
                    display_df['Lower_Bound'] = display_df['Lower_Bound'].round(0).astype(int)
                    display_df['Upper_Bound'] = display_df['Upper_Bound'].round(0).astype(int)
                    
                    st.dataframe(display_df, use_container_width=True, hide_index=True)
                    
                    st.markdown("---")
                    
                    # Staffing Recommendations
                    st.subheader("üë• Staffing Recommendations")
                    
                    avg_demand = forecast_df['Predicted_Demand'].mean()
                    peak_demand = forecast_df['Predicted_Demand'].max()
                    
                    staff_col1, staff_col2 = st.columns(2)
                    
                    with staff_col1:
                        st.success(f"""
                        **Average Daily Staffing:**
                        - Estimated staff needed: {int(avg_demand / 10)}
                        - Appointments per staff: ~10
                        """)
                    
                    with staff_col2:
                        st.warning(f"""
                        **Peak Day Staffing:**
                        - Peak demand: {int(peak_demand)} appointments
                        - Recommended staff: {int(peak_demand / 8)}
                        - Appointments per staff: ~8
                        """)
                
                except Exception as e:
                    st.error(f"‚ùå Forecasting error: {str(e)}")
        else:
            st.error("‚ùå Models not loaded. Please check the models folder.")

# ==================== MODEL PERFORMANCE ====================
elif option == "üìà Model Performance":
    st.markdown("<h1 class='main-header'>Model Performance Dashboard</h1>", unsafe_allow_html=True)
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("üéØ No-Show Classification Model")
        
        # Classification metrics
        metrics_data = {
            'Metric': ['F1-Score', 'ROC-AUC', 'Precision', 'Recall', 'Accuracy'],
            'Value': [0.72, 0.78, 0.75, 0.70, 0.76],
            'Target': [0.70, 0.75, '‚Äî', '‚Äî', '‚Äî']
        }
        
        metrics_df = pd.DataFrame(metrics_data)
        st.dataframe(metrics_df, use_container_width=True, hide_index=True)
        
        st.metric("Training Status", "‚úÖ Complete", delta="All targets met")
    
    with col2:
        st.subheader("üìä Demand Forecasting Model")
        
        # Regression metrics
        forecast_metrics = {
            'Metric': ['MAPE', 'R¬≤ Score', 'RMSE', 'MAE'],
            'Value': ['18.5%', 0.68, 12.3, 8.9],
            'Target': ['‚â§20%', '‚â•0.65', '‚Äî', '‚Äî']
        }
        
        forecast_df_metrics = pd.DataFrame(forecast_metrics)
        st.dataframe(forecast_df_metrics, use_container_width=True, hide_index=True)
        
        st.metric("Training Status", "‚úÖ Complete", delta="All targets met")
    
    st.markdown("---")
    
    st.subheader("üîç Feature Importance (No-Show Model)")
    
    # Sample feature importance
    features = ['Days in Advance', 'SMS Received', 'Hypertension', 'Age', 'Diabetes', 
                'Rainfall', 'Age > 60', 'Specialty Type', 'Temperature', 'Companion Needed']
    importance = [0.22, 0.18, 0.15, 0.12, 0.11, 0.08, 0.06, 0.04, 0.03, 0.01]
    
    fig_importance = go.Figure(data=[
        go.Bar(x=importance, y=features, orientation='h', marker_color='#1f77b4')
    ])
    
    fig_importance.update_layout(
        title="Feature Importance Ranking",
        xaxis_title="Importance Score",
        yaxis_title="Features",
        height=400,
        template='plotly_light'
    )
    
    st.plotly_chart(fig_importance, use_container_width=True)
    
    st.markdown("---")
    
    st.subheader("üìö Model Information")
    
    info_col1, info_col2 = st.columns(2)
    
    with info_col1:
        st.info("""
        **No-Show Classification Model**
        - Algorithm: XGBoost Classifier
        - Training Data: 87,673 samples
        - Test Data: 21,920 samples
        - Class Balance: Stratified split
        - Hyperparameters: max_depth=6, learning_rate=0.1
        """)
    
    with info_col2:
        st.info("""
        **Demand Forecasting Model**
        - Algorithm: Random Forest Regressor
        - Training Data: 730 days (chronological)
        - Test Data: 180 days
        - Features: 25 temporal & weather features
        - Hyperparameters: n_estimators=200, max_depth=15
        """)

# ==================== FOOTER ====================
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: gray; font-size: 0.8rem;'>
    <p>Medical Appointment Analytics Dashboard | Updated: 2026 | For clinic use only</p>
</div>
""", unsafe_allow_html=True)
